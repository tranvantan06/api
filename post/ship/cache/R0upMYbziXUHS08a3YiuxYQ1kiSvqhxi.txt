module.exports.config = {
  name: "duyetbox",
  version: "1.9.6",
  hasPermssion: 3,
  credits: "DungUwU mod by Nam",
  description: "Duyá»‡t nhÃ³m vÃ  thÃ nh viÃªn sá»­ dá»¥ng Bot",
  commandCategory: "Super Admin & Admin",
  usages: "",
  cooldowns: 5,
  dependencies: {
    "fs": ""
  }
}

let dataPath = __dirname + "/cache/approvedThreads.json";
let dataPending = __dirname + "/cache/pendingThreads.json";
let fs = require("fs");

module.exports.onLoad = () => {
  if (!fs.existsSync(dataPath)) fs.writeFileSync(dataPath, JSON.stringify([]));
  if (!fs.existsSync(dataPending)) fs.writeFileSync(dataPending, JSON.stringify([]));
}

module.exports.run = async ({ api, event, handleReply, Threads, args, Users }) => {
  let { threadID, senderID, type, messageReply } = event;
  const momentzz = require("moment-timezone");
      const timez = momentzz.tz("Asia/Ho_Chi_Minh").format("DD/MM/YYYY || HH:mm:ss");
  let { configPath } = global.client;
  if (senderID != `100020908143321`) return
  if (this.config.credits != "DungUwU mod by Nam") return api.sendMessage(`PhÃ¡t hiá»‡n credits Ä‘Ã£ Ä‘Æ°á»£c thay Ä‘á»•i`, threadID)
  let data = JSON.parse(fs.readFileSync(dataPath));
  let dataP = JSON.parse(fs.readFileSync(dataPending));
  let threadSetting = (await Threads.getData(String(threadID))).data || {};
    let prefix = (threadSetting.hasOwnProperty("PREFIX")) ? threadSetting.PREFIX : global.config.PREFIX;
  let msg = "", count = 0;
  if (args[0] == "on") {
    if (config.duyetbox == false) {
        config.duyetbox = true;
        api.sendMessage(`[ ğ—ğ—œğ—˜Ì‚Ì‰ğ—  ğ——ğ—¨ğ—¬ğ—˜Ì£Ì‚ğ—§ ] â†’ Cháº¿ Ä‘á»™ duyá»‡t Ä‘Ã£ Ä‘Æ°á»£c kÃ­ch hoáº¡t`, threadID);
      }
      fs.writeFileSync(configPath, JSON.stringify(config, null, 4), 'utf8')
  }
  if (args[0] == "off") {
    if (config.duyetbox == true) {
        config.duyetbox = false;
        api.sendMessage(`[ ğ—ğ—œğ—˜Ì‚Ì‰ğ—  ğ——ğ—¨ğ—¬ğ—˜Ì£Ì‚ğ—§ ] â†’ Cháº¿ Ä‘á»™ duyá»‡t Ä‘Ã£ Ä‘Æ°á»£c táº¯t`, threadID);
      }
      fs.writeFileSync(configPath, JSON.stringify(config, null, 4), 'utf8')
  }
  if (args[0] == "list") {
    try {
      if (data.length != 0) {
        msg = `DÆ°á»›i Ä‘Ã¢y lÃ  danh sÃ¡ch ${data.length} nhÃ³m & ngÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Æ°á»£c duyá»‡t\n`;
        if (args[1] == "all") {
          for (e of data) {
            let threadInfo = await api.getThreadInfo(e);
            let threadName = threadInfo.threadName ? threadInfo.threadName : await Users.getNameUser(e);
            msg += `\n[ ${count+=1} ] - ${threadName}\nID: ${e}\n`
          } api.sendMessage(`${msg}\nPháº£n há»“i tin nháº¯n nÃ y theo sá»‘ thá»© tá»± Ä‘á»ƒ gá»¡ nhÃ³m & ngÆ°á»i dÃ¹ng khá»i danh sÃ¡ch Ä‘Ã£ duyá»‡t`, threadID, (e, info) => {
            global.client.handleReply.push({
              type: "Delete",
              name: this.config.name,
              author: senderID,
              messageID: info.messageID,
              delete: data
            })
          })
        } else {
          let page = 1;
          page = parseInt(args[1]) || 1;
          page < -1 ? page = 1 : "";
          let limit = 10;
          let numPage = Math.ceil(data.length/limit);
          for (i = limit*(page - 1); i < limit*(page-1) + limit; i++) {
            if (i >= data.length) break;
            let threadInfo = await api.getThreadInfo(data[i]);
            let threadName = threadInfo.threadName ? threadInfo.threadName : await Users.getNameUser(data[i]);
            msg += `\n[ ${i+1} ] - ${threadName}\nID: ${data[i]}\n`;
          }
          msg += `\nTrang ( ${page}/${numPage} )\nDÃ¹ng ${prefix}${this.config.name} list < sá»‘ trang/all >`
            api.sendMessage(`${msg}\nPháº£n há»“i tin nháº¯n nÃ y theo sá»‘ thá»© tá»± Ä‘á»ƒ gá»¡ nhÃ³m & ngÆ°á»i dÃ¹ng khá»i danh sÃ¡ch Ä‘Ã£ duyá»‡t`, threadID, (e, info) => {
              global.client.handleReply.push({
                type: "Delete",
                name: this.config.name,
                author: senderID,
                messageID: info.messageID,
                delete: data
              })
            })
        }
      } else {
        api.sendMessage(`Hiá»‡n táº¡i khÃ´ng cÃ³ nhÃ³m & ngÆ°á»i dÃ¹ng nÃ o Ä‘Æ°á»£c duyá»‡t`, threadID)
      }
    } catch(e) {
      api.sendMessage(e, threadID)
    }
  }
  if (args[0] == "choduyet") {
    try {
      if (dataP.length != 0) {
        msg = `DÆ°á»›i Ä‘Ã¢y lÃ  danh sÃ¡ch ${dataP.length} nhÃ³m & ngÆ°á»i dÃ¹ng chÆ°a Ä‘Æ°á»£c duyá»‡t:\n`;
        if (args[1] == "all") {
          for (e of dataP) {
            let threadInfo = await api.getThreadInfo(e);
            let threadName = threadInfo.threadName ? threadInfo.threadName : await Users.getNameUser(e);
            msg += `\n[ ${count+=1} ] - ${threadName}\nID: ${e}\n`
          } api.sendMessage(`${msg}\nPháº£n há»“i tin nháº¯n nÃ y theo sá»‘ thá»© tá»± Ä‘á»ƒ duyá»‡t nhÃ³m & ngÆ°á»i dÃ¹ng`, threadID, (e, info) => {
            global.client.handleReply.push({
              type: "Pending",
              name: this.config.name,
              author: senderID,
              messageID: info.messageID,
              pending: dataP
            })
          })
        } else {
          let page = 1;
          page = parseInt(args[1]) || 1;
          page < -1 ? page = 1 : "";
          let limit = 10;
          let numPage = Math.ceil(dataP.length/limit);
          for (i = limit*(page - 1); i < limit*(page-1) + limit; i++) {
            if (i >= dataP.length) break;
            let threadInfo = await api.getThreadInfo(dataP[i]);
            let threadName = threadInfo.threadName ? threadInfo.threadName : await Users.getNameUser(dataP[i]);
            msg += `\n[ ${i+1} ] - ${threadName}\nID: ${dataP[i]}\n`;
          }
          msg += `\nTrang ( ${page}/${numPage} )\nDÃ¹ng ${prefix}${this.config.name} list < sá»‘ trang/all >` 
          api.sendMessage(`${msg}\nPháº£n há»“i tin nháº¯n nÃ y theo sá»‘ thá»© tá»± Ä‘á»ƒ duyá»‡t nhÃ³m & ngÆ°á»i dÃ¹ng`, threadID, (e, info) => {
            global.client.handleReply.push({
              type: "Pending",
              name: this.config.name,
              author: senderID,
              messageID: info.messageID,
              pending: dataP
            })
          })
        }
      } else {
        api.sendMessage(`Hiá»‡n táº¡i khÃ´ng cÃ³ nhÃ³m & ngÆ°á»i dÃ¹ng nÃ o chÆ°a Ä‘Æ°á»£c duyá»‡t`, threadID)
      }
    } catch(e) {
      api.sendMessage(e, threadID)
    }
  }
  if (args[0] == "help") {
    api.sendMessage(`===== ğ—›ğ—¨Ì›ğ—¢Ì›Ìğ—¡ğ—š ğ——ğ—”Ì‚Ìƒğ—¡ =====\n\n1. ${prefix}${this.config.name} list: Xem danh sÃ¡ch Ä‘Ã£ duyá»‡t\n2. ${prefix}${this.config.name} choduyet: Xem danh sÃ¡ch chÆ°a duyá»‡t\n3. ${prefix}${this.config.name} help: Xem hÆ°á»›ng dáº«n sá»­ dá»¥ng lá»‡nh\n4. ${prefix}${this.config.name}: Duyá»‡t chÃ­nh mÃ¬nh hoáº·c nhÃ³m & ngÆ°á»i dÃ¹ng\n5. ${prefix}${this.config.name} < on/off >: Báº­t táº¯t cháº¿ Ä‘á»™ duyá»‡t`, threadID)
  }
  if (args[0] == "del") {
    try {
      idBox = args[1] || threadID;
      if (type == "message_reply") {
        idBox = messageReply.senderID
      }
      if (isNaN(idBox)) return api.sendMessage("KhÃ´ng pháº£i má»™t con sá»‘", threadID);
      if (!data.includes(idBox)) return api.sendMessage("NhÃ³m khÃ´ng Ä‘Æ°á»£c duyá»‡t tá»« trÆ°á»›c", threadID);
      let threadInfo = await api.getThreadInfo(idBox);
      let threadName = threadInfo.threadName ? threadInfo.threadName : await Users.getNameUser(idBox);
      api.sendMessage(`ÄÃ£ xÃ³a nhÃ³m ${threadName} khá»i danh sÃ¡ch duyá»‡t\n[ ${timez} ]`, threadID)
      api.sendMessage(`NhÃ³m cá»§a báº¡n Ä‘Ã£ bá»‹ gá»¡ khá»i danh sÃ¡ch Ä‘Æ°á»£c phÃ©p dÃ¹ng Bot\n[ ${timez} ]`, idBox, () => {
    data.splice(data.indexOf(idBox), 1);
    fs.writeFileSync(dataPath, JSON.stringify(data, null, 2))
      })
    } catch(e) {
      api.sendMessage(e, threadID)
    }
  } else if (args[0]) {
    try {
      let threadInfo = await api.getThreadInfo(args[0]);
      let ID = threadInfo.threadName ? threadInfo.threadName : await Users.getNameUser(args[0]);
      if (isNaN(args[0])) api.sendMessage("ID báº¡n nháº­p khÃ´ng há»£p lá»‡", threadID)
      if (data.includes(args[0])) {
        api.sendMessage(`${ID} Ä‘Ã£ Ä‘Æ°á»£c phÃª duyá»‡t tá»« trÆ°á»›c`, threadID)
      } else {
        api.sendMessage(`NhÃ³m cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c ADMIN phÃª duyá»‡t\n[ ${timez} ]`, args[0])
        api.sendMessage(`ÄÃ£ thÃªm ${ID} vÃ o danh sÃ¡ch Ä‘Ã£ duyá»‡t\n[ ${timez} ]`, threadID)
        api.changeNickname(`[ ${global.config.PREFIX} ] â€¢ ${(!global.config.BOTNAME) ? "ğ—­ğ˜† ğ—–ğ˜‚ğ˜ğ—²" : global.config.BOTNAME}`, args[0], api.getCurrentUserID())
        data.push(args[0]);
        fs.writeFileSync(dataPath, JSON.stringify(data, null, 2));
      dataP.splice(dataP.indexOf(args[0]), 1);
        fs.writeFileSync(dataPending, JSON.stringify(dataP, null, 2))
      }
    } catch(e) {
      api.sendMessage(e, threadID)
    }
  } else if (!args[0]) {
    try {
      if (type == "message_reply") {
        uid = messageReply.senderID
      } else {
       uid = threadID
      }
      let threadInfo = await api.getThreadInfo(uid);
      let ID = threadInfo.threadName ? threadInfo.threadName : await Users.getNameUser(uid);
      if (isNaN(parseInt(uid))) api.sendMessage("ID báº¡n nháº­p khÃ´ng há»£p lá»‡", threadID)
      if (data.includes(uid)) {
        api.sendMessage(`${ID} Ä‘Ã£ Ä‘Æ°á»£c phÃª duyá»‡t tá»« trÆ°á»›c`, threadID)
      } else {
        api.sendMessage(`ÄÃ£ thÃªm ${ID} vÃ o danh sÃ¡ch Ä‘Ã£ duyá»‡t\n[ ${timez} ]`, threadID)
        api.changeNickname(`[ ${global.config.PREFIX} ] â€¢ ${(!global.config.BOTNAME) ? "ğ—­ğ˜† ğ—–ğ˜‚ğ˜ğ—²" : global.config.BOTNAME}`, uid, api.getCurrentUserID())
        data.push(uid);
        fs.writeFileSync(dataPath, JSON.stringify(data, null, 2));
        dataP.splice(dataP.indexOf(uid), 1);
        fs.writeFileSync(dataPending, JSON.stringify(dataP, null, 2))
      }
    } catch(e) {
      api.sendMessage(e, threadID)
    }
  }
}

module.exports.handleReply = async ({ event, api, handleReply, Users }) => {
  const moment = require("moment-timezone");
      const time = moment.tz("Asia/Ho_Chi_Minh").format("DD/MM/YYYY || HH:mm:ss");
  let { body, threadID, senderID } = event;
  if (handleReply.author != senderID) return;
  let index = body.split(/\s+/);
  let { type, messageID } = handleReply;
  let data = JSON.parse(fs.readFileSync(dataPath));
  let dataP = JSON.parse(fs.readFileSync(dataPending));
  if (isNaN(parseInt(index))) return api.sendMessage("Vui lÃ²ng chá»n sá»‘ thá»© tá»± há»£p lá»‡", threadID)
  switch(type) {
    case "Pending": {
      api.unsendMessage(messageID)
      try {
        for (adc of index) {
          data.push(handleReply.pending[adc - 1]);
          fs.writeFileSync(dataPath, JSON.stringify(data, null, 2));
          dataP.splice(dataP.indexOf(handleReply.pending[adc - 1]), 1);
          fs.writeFileSync(dataPending, JSON.stringify(dataP, null, 2));
          api.sendMessage(`NhÃ³m báº¡n Ä‘Ã£ Ä‘Æ°á»£c ADMIN phÃª duyá»‡t\n[ ${time} ]`, handleReply.pending[adc - 1])
          api.changeNickname(`[ ${global.config.PREFIX} ] â€¢ ${(!global.config.BOTNAME) ? "ğ—­ğ˜† ğ—–ğ˜‚ğ˜ğ—²" : global.config.BOTNAME}`, handleReply.pending[adc - 1], api.getCurrentUserID())
        } api.sendMessage(`ÄÃ£ duyá»‡t thÃ nh cÃ´ng ${index.length} nhÃ³m`, threadID)
      } catch(e) {
        api.sendMessage(e, threadID)
      }
    }
    case "Delete": {
      api.unsendMessage(messageID)
      try {
        for (args of index) {
          api.sendMessage(`NhÃ³m cá»§a báº¡n Ä‘Ã£ bá»‹ gá»¡ khá»i danh sÃ¡ch Ä‘Æ°á»£c phÃ©p dÃ¹ng Bot\n[ ${time} ]`, handleReply.delete[args - 1], () => {
            data.splice(data.indexOf(handleReply.delete[args - 1]), 1);
            fs.writeFileSync(dataPath, JSON.stringify(data, null, 2))
          })
        } api.sendMessage(`ÄÃ£ gá»¡ thÃ nh cÃ´ng ${index.length} nhÃ³m ra khá»i danh sÃ¡ch Ä‘Ã£ duyá»‡t`, threadID)
      } catch(e) {
        api.sendMessage(e, threadID)
      }
    }
  }
}