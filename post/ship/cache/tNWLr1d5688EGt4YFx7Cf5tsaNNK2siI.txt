module.exports.config = {
name: "rela",
version: "1.0.0",
hasPermssion: 0,
credits: "DVB Developer",//Mod by H.Thanh
description: "TÃ¬nh yÃªu Ä‘áº¿n nÃ¨",
commandCategory: "TÃ¬nh yÃªu",
usages: "< mention > | < info > | < fake >"
};

module.exports.languages = {"vi": {}}

//Äá»c Package
const fs = require("fs-extra");
const { loadImage, createCanvas, registerFont, Canvas} = require("canvas");

//CÃ i Ä‘áº·t nhanh
var D = __dirname + "/cache/rela/"; //fila xuáº¥t
var expole = D + "rela.png", //Xuáº¥t áº£nh ra file
    bg     = D + "bg.png", // Ä‘á»c file áº£nh background
    dicon  = D + "icon.png", // Ä‘á»c file áº£nh icon trÃ¡i tim
    font   = D + "AmaticSC.ttf"; // Ä‘á»c file font

//Link file
var token = "6628568379%7Cc1e620fa708a1d5696fb991c1bde5662", // Token fb
    bglink = "https://blogger.googleusercontent.com/img/a/AVvXsEgiT494Po7Onhcft4jFS2cTSb2-7wbRYaoCCGFH09X53RtuI3YABGgYfMJsCAmsDs8hfpMU2k28PKwImiP6Go9LiOquM0CYR4bEgzH8yXIfsJ8CJHdnRcogIOef0tgdzIjTBsGROv-12T60AI2njz0p_N9ipS5T4_KMatV8Erl6GYJ6PLou2HeIRWrA=s1278",
    iconlink = "https://blogger.googleusercontent.com/img/a/AVvXsEgQpVe6Q9RLyMZolNU3K7PqmAyKbIz53aIcAux5P9X7gbXydjEbkbZSKHxiwTLrY_XmgSeJJgrTi8-jh6g8RuWvq8h4mfQOA470attJaNuHWI9AP28SVUiTF8gaggPUeeQ4zq7OT5kgO4qvQsloqIVxJue7cFZmDwaxHNI8UVHqxrCsA_BXwvEYskq9=s45",
    fontlink = "https://drive.google.com/u/0/uc?id=1ZzgC7nyGaBw-zP3V2GKK0azoFgF5aXup&export=download";

//onload ( leak cá»§a aesn )
module.exports.onLoad = async() => {
  const { resolve } = global.nodemodule["path"];
  const { existsSync, mkdirSync } = global.nodemodule["fs-extra"];
  const { downloadFile } = global.utils;
  if (!existsSync(D)) mkdirSync(D, { recursive: true });
  if (!existsSync(bg)) await downloadFile(bglink, resolve(bg));
  if (!existsSync(dicon)) await downloadFile(iconlink, resolve(dicon));
  if (!existsSync(font)) await downloadFile(fontlink, resolve(font));
}

//Máº£ng data
var data = [
  "TrÃ¡ch pháº­n vÃ´ duyÃªn...",
  "HÆ¡i tháº¥p nhÆ°ng khÃ´ng sao. HÃ£y cá»‘ gáº¯ng lÃªn",
  "3 pháº§n duyÃªn ná»£, 7 pháº§n cá»‘ gáº¯ng",
  "Tá»‰ lá»‡ mÃ  má»‘i quan há»‡ nÃ y cÃ³ thá»ƒ nÃªn duyÃªn cÅ©ng khÃ¡ lÃ  nhá» Ä‘áº¥y...Pháº£i cá»‘ gáº¯ng hÆ¡n ná»¯a",
  "Date vá»›i nhau Ä‘i. Äá»ƒ má»‘i quan há»‡ nÃ y cÃ³ thá»ƒ tiáº¿n xa hÆ¡n",
  "HÃ£y chá»§ Ä‘á»™ng báº¯t chuyá»‡n hÆ¡n ná»¯a. Hai báº¡n khÃ¡ lÃ  há»£p Ä‘Ã´i",
  "HÃ£y tin vÃ o duyÃªn sá»‘ Ä‘i, vÃ¬ nÃ³ cÃ³ tháº­t Ä‘áº¥y",
  "Há»£p Ä‘Ã´i láº¯m Ä‘áº¥y. Quan tÃ¢m chÄƒm sÃ³c cho má»‘i quan há»‡ nÃ y nhiá»u hÆ¡n ná»¯a nhÃ©",
  "LÆ°u sá»‘ nhau Ä‘i, bao giá» cÆ°á»›i thÃ¬ gá»i nhau lÃªn lá»… Ä‘Æ°á»ng",
  "CÆ°á»›i Ä‘i chá» chi"
];


//Báº¯t Ä‘áº§u modules
module.exports.run = async function({ api, event, args, Threads, Users, permssion}) {

//Láº¥y mentions (TÃªn ngÆ°á»i tag)
var mentions1 = event.mentions[Object.keys(event.mentions)];
if(!mentions1) { 
  // check args (Check Ä‘áº§u vÃ o)
  if(args[0] == "info"){return api.sendMessage(`=== ð——ð—©ð—• ð——ð—˜ð—©ð—˜ð—Ÿð—¢ð—£ð—˜ð—¥ ===\n=> Há»— trá»£ code: Nguyá»…n ThÃ¡i Háº£o\n=> Ã tÆ°á»Ÿng: LÃª Äá»‹nh`,event.threadID,event.messageID)}
  else{return api.sendMessage(`=> Sá»­ dá»¥ng lá»‡nh < tag >\n=> Sá»­ dá»¥ng lá»‡nh < info > | < fake >\n=> Info sá»­ dá»¥ng Ä‘á»ƒ xem thÃ´ng tin nhÆ° credit\n=> Fake sá»­ dá»¥ng Ä‘á»ƒ táº¡o banner fake thÃ´ng tin`,event.threadID,event.messageID)};
};

//Láº¥y name
name1 = await Users.getNameUser(event.senderID);
name2 = await mentions1.replace("@", "");

//HÃ m táº£i áº£nh Ä‘áº§u váº£o
background = await loadImage(bg);
icon = await loadImage(dicon);

// Láº¥y uid2 ( uid ngÆ°á»i tag)
uid2 = Object.keys(event.mentions)[0];

// check args (Check Ä‘áº§u vÃ o)
if(args[0] == "fake"){
 
//Cháº¡y handle reply
return api.sendMessage(`Vui lÃ²ng nháº­p sá»‘ tym cá»§a báº¡n vÃ­ dá»¥ 8|8|8|8|8`, event.threadID, (err, info) => {
      return global.client.handleReply.push({
      type: "create",
      name: this.config.name,
      author: event.senderID,
      messageID: info.messageID
    });
  }, event.messageID);
};

//HÃ m táº¡o máº£ng random
MissionC = Array.from({length: 5}, () => Math.floor(Math.random() * 8));

//HÃ m tÃ­nh tá»•ng
var allmath = (MissionC[0]+MissionC[1]+MissionC[2]+MissionC[3]+MissionC[4]) * 2.5;

//KÃ­ch hoáº¡t chá»©c nÄƒng so sÃ¡nh Ä‘á»ƒ láº¥y text
var message = sosanh(allmath);
 
//Táº£i & KÃ­ch hoáº¡t chá»©c nÄƒng láº¥y avt
var getboyavt = await loadImage(await getavt(event.senderID)),
    getgirlavt = await loadImage(await getavt(uid2));

//KÃ­ch hoáº¡t chá»©c nÄƒng render (Táº¡o áº£nh)
var render = await irender(allmath, message, name1, name2, getboyavt, getgirlavt);

//lÆ°u áº£nh sau khi render render (LÆ°u cache)
fs.writeFileSync(expole, Buffer.from(render,'utf8'));

//Tin nháº¯n gá»­i Ä‘i -  Ä‘Æ°á»£c phÃ©p tÃ¹y chá»‰nh
var send = {
  body: "ChÃºc má»«ng "+name1+" & "+name2+`\n`+ message,
  attachment: fs.createReadStream(expole)
};

//HÃ m gá»­i tin nháº¯n lÃªn fca
api.sendMessage(send,event.threadID,event.messageID);
 
};

module.exports.handleReply = async function({ api, event, args, handleReply, client, __GLOBAL, Threads, Users, Currencies }) {
    var info = await api.getUserInfo(event.senderID);
    var nameSender = info[event.senderID].name;
    var arraytag = [];
        arraytag.push({id: event.senderID, tag: nameSender});
    if (handleReply.author != event.senderID) return;
    const {threadID, messageID, senderID } = event;
    switch (handleReply.type) {
    case "create": {
    var tym = event.body;
    MissionC = tym.split("|");
     
    //HÃ m láº¥y avt
    var getboyavt = await loadImage(await getavt(senderID)),
        getgirlavt = await loadImage(await getavt(uid2));
    try{
     
    //HÃ m soÃ¡t máº£ng
    if(!MissionC.length == "5"){return api.sendMessage(`Thiáº¿u sá»‘ hoáº·c sai Ä‘á»‹nh dáº¡ng`, threadID, messageID)}
     
    //HÃ m tÃ­nh tá»•ng
    var allmath = (parseInt(MissionC[0])+parseInt(MissionC[1])+parseInt(MissionC[2])+parseInt(MissionC[3])+parseInt(MissionC[4])) * 2.5;
    }catch(e){
      api.sendMessage(`Thiáº¿u sá»‘ hoáº·c sai Ä‘á»‹nh dáº¡ng\nLá»—i: ${e}`, threadID, messageID);
    };
   
    //KÃ­ch hoáº¡t chá»©c nÄƒng so sÃ¡nh Ä‘á»ƒ láº¥y text
    var message = sosanh(allmath);
     
    //KÃ­ch hoáº¡t chá»©c nÄƒng render (Táº¡o áº£nh)
    var render = await irender(allmath, message, name1, name2, getboyavt, getgirlavt);
   
    //lÆ°u áº£nh sau khi render render (LÆ°u cache)
    fs.writeFileSync(expole, Buffer.from(render,'utf8'));
   
    //Tin nháº¯n gá»­i Ä‘i -  Ä‘Æ°á»£c phÃ©p tÃ¹y chá»‰nh
    var send = {
    body: "ChÃºc má»«ng "+name1+" & "+name2+`\n`+ message +`\n ${MissionC}`,
    attachment: fs.createReadStream(expole)
    }
     
    //HÃ m gá»­i tin nháº¯n lÃªn fca
    api.sendMessage(send, threadID, messageID);

    // BÃ­ máº­t =))
    if ((this.config.credits) != "DVB Developer") { return api.sendMessage(`CÃ³ gÃ¬ cho Báº±ng xin láº¡i cÃ¡i credit nhÃ¡ :3`, event.threadID, event.messageID)}
}
}
};

////////////////////////////
/// Function (Chá»©c náº¯ng) ///
////////////////////////////

//Chá»©c nÄƒng so sÃ¡nh xuáº¥t text
function sosanh(rd) {
  let ss;
  if(rd < 10) {
    ss = data[0];
  }else if(rd < 20){
    ss = data[1];
  }else if(rd < 30){
    ss = data[2];
  }else if(rd < 40){
    ss = data[3];
  }else if(rd < 50){
    ss = data[4];
  }else if(rd < 60){
    ss = data[5];
  }else if(rd < 70){
    ss = data[6];
  }else if(rd < 80){
    ss = data[7];
  }else if(rd < 90){
    ss = data[8];
  }else {
    ss = data[9];
  }
  return ss;
};

//Chá»©c nÄƒng láº¥y avt
async function getavt(uid) {
  var axios = require("axios");
  var { data } = await axios.get(`https://graph.facebook.com/v12.0/${uid}/picture?height=240&width=240&access_token=${token}`,{ responseType:"arraybuffer" });
  return data;
};

//Chá»©c nÄƒng render áº£nh (Xuáº¥t áº£nh)
function irender( tile, msg, boyname, girlname, getboyavt, getgirlavt) {
  registerFont(font, {family: "AmaticSCbold"});
  var canvas = createCanvas(background.width, background.height);
  var ctx = canvas.getContext("2d");

  //Váº½ 2 avt
  ctx.drawImage(getboyavt, 114, 581, 98 , 98);
  ctx.drawImage(getgirlavt, 509, 581, 98 , 98);
  ctx.restore();
  ctx.save();

  //Váº½ background (ná»n)
  ctx.drawImage(background, 0, 0);
  ctx.font = "150px AmaticSCbold";
  ctx.textAlign = "center";
  ctx.fillStyle = "#FFFFFE";
  ctx.fillText(tile+"%", 360, 340);
  ctx.restore();
  ctx.save();

  //Váº½ & tÃ­nh trÃ¡i tim
  var math = 806;
  math -= 50;
  for(var i = 0; i < 5; i+=1) {
    var leftmath = 170;
    math += 50;
    for(var ii = 0; ii < MissionC[i]; ii+=1) {
      leftmath += 55;
      ctx.drawImage(icon, leftmath , math);
    }
  }
  ctx.restore();
  ctx.save();

  //Váº½ chá»¯
  ctx.font = "50px AmaticSCbold";
  ctx.textAlign = "center";
  ctx.fillStyle = "#000000";
  ctx.fillText(boyname, 163, 746);
  ctx.fillText(girlname, 557, 746);
  ctx.restore();
  ctx.save();
 
  //Váº½ chá»¯
  ctx.font = "45px AmaticSCbold";
  ctx.textAlign = "start";
  ctx.fillStyle = "#000000";
  //KÃ­ch hoáº¡t chá»©c nÄƒng cÄƒn chá»‰nh chá»¯
  const xuongdong = wrapText(ctx, msg, 640);
  ctx.fillText(xuongdong.join("\n"), 60, 1145);
  ctx.restore();
  ctx.save();

  //Xuáº¥t áº£nh
  return canvas.toBuffer("image/png");
};

//Chá»©c nÄƒng chá»‰nh & cÄƒn text
function wrapText(ctx, text, max){
  const lines = [];
  if (ctx.measureText(text).width > max){
    const words = text.split(" ");
    let line = "";
    while (words.length > 0) {
      let split = false;
      while (ctx.measureText(words[0]).width >= max) {
        const temp = words[0];
        words[0] = temp.slice(0, -1);
        if (split) words[1] = temp.slice(-1) + words[1];
        else {
          split = true;
          words.splice(1, 0, temp.slice(-1));
        }
      }
      if (ctx.measureText(line+words[0]).width < max)
        line += words.shift()+" ";
      else {
        lines.push(line.trim());
        line = "";
      }
      if (words.length === 0) lines.push(line.trim());
    }
    }else{
      lines.push(text);
    }
    return lines;
}; 