const configCommand = {
  name: 'autodownurl',
  version: '1.1.1',
  hasPermssion: 2,
  credits: 'DC-Nam',
  description: 'Tá»± Ä‘á»™ng táº£i xuá»‘ng khi phÃ¡t hiá»‡n liÃªn káº¿t',
  commandCategory: 'ð“ð¢ðžð§ ð¢ðœð¡',
  usages: '[]',
  cooldowns: 3
},
  axios = require('axios'),
  downloader = require('image-downloader'),
  fse = require('fs-extra'),
  toolsFb = {
    getVideoUrl: async (url) => {
      const res = await axios.get("https://api-thanhali.thanhali.repl.co/fbdownload?apikey=ThanhAliVip_1234567890&url=" + encodeURIComponent(url));
      return res.data.data.medias[res.data.data.medias.length - 1].url;
    }
  },
  path = __dirname + '/cache/statusAuto.json';

const https = require("https");
const agent = new https.Agent({
  rejectUnauthorized: false
});

async function streamURL(url, mime) {
  // const dest = `${__dirname}/cache/${Date.now()}.${mime}`;
  const name = global.utils.randomString(5) + '.' + mime;
  // await downloader.image({
  //     url, dest
  // });
  // setTimeout(j => fse.unlinkSync(j), 60 * 1000, dest);
  // return fse.createReadStream(dest);
  const res = await axios({
    url,
    method: 'GET',
    responseType: 'stream'
  });
  res.data.path = name;
  return res.data;
}

function onLoad() {
  if (!fse.existsSync(path)) fse.writeFileSync(path, '{}');
}

async function noprefix(arg) {
  const s = JSON.parse(fse.readFileSync(path));
  if (arg.event.senderID == (global.botID || arg.api.getCurrentUserID())) return;
  if ((typeof s[arg.event.threadID] == 'boolean' && !s[arg.event.threadID])) return;

  const out = (a, b, c, d) => arg.api.sendMessage(a, b ? b : arg.event.threadID, c ? c : null, d ? d : arg.event.messageID),
    arr = arg.event.args || [],
    regEx_tiktok = /(^https:\/\/)((vm|vt|www|v)\.)?(tiktok|douyin)\.com\//,
    regEx_youtube = /(^https:\/\/)((www)\.)?(youtube|youtu)(PP)*\.(com|be)\//,
    regEx_facebook = /(^https:\/\/)(\w+\.)?(facebook|fb)\.(com|watch)\/\w+\/\w?(\/)?/,
    regEx_instagram = /^\u0068\u0074\u0074\u0070\u0073\u003a\/\/(www\.)?instagram\.com\/(reel|p)\/\w+\/\w*/;

  for (const el of arr) {
    /* Tá»° Äá»˜NG Táº¢I VIDEO TIKTOK */
    if (regEx_tiktok.test(el)) {
      const data = (await axios.post(`https://www.tikwm.com/api/`, {
        url: el
      })).data.data;
      out({
        body: `ã€Ž ðš‚ðš˜ðš—ðš ðšƒá»­ ð™°ðšžðšðš˜ð™³ðš˜ðš ðš—ðš•ðš˜ðšŠðš ã€\n- TiÃªu Ä‘á»: ${data.title}\n- LÆ°á»£t thÃ­ch: ${data.digg_count}\n- LÆ°á»£t bÃ¬nh luáº­n: ${data.comment_count}\n- LÆ°á»£t chia sáº»: ${data.share_count}\n- LÆ°á»£t táº£i: ${data.download_count}\n\n- Tháº£ cáº£m xÃºc "ðŸ¦‹" Ä‘á»ƒ táº£i nháº¡c`, attachment: await streamURL(data.play, 'mp4')
      }, '', (err, dataMsg) => global.client.handleReaction.push({
        name: 'autodownurl', messageID: dataMsg.messageID, url_audio: data.music
      })); // Video khÃ´ng logo thÃ¬ sá»­a "wmplay" -> "play";
    }
    /* END */

    /* Tá»° Dá»˜NG Táº¢I VIDEO YOUTUBE */
    if (regEx_youtube.test(el)) {
      const data = (await axios.get(`https://api-thanhali.thanhali.repl.co/youtube/download`, {
        params: {
          id: el,
          apikey: 'ThanhAliVip_1234567890'
        }
      })).data;
      const info = (a) => `ã€Ž ðš‚ðš˜ðš—ðš ðšƒá»­ ð™°ðšžðšðš˜ð™³ðš˜ðš ðš—ðš•ðš˜ðšŠðš ã€\n- TiÃªu Ä‘á»: ${a.title}\n- Thá»i gian: ${a.t}s`;
      const MAX_SIZE = 87031808;
      const getFormatVideo = (data.links.find(f => f.type === "mp4" || f.type == 'm4a').qualitys.filter(f => f.size < MAX_SIZE) || []);
      const getFormatAudio = (data.links.find(f => f.type === "mp3").qualitys.filter(f => f.size < MAX_SIZE) || [])[0];
      // if (!getFormatVideo)
      //     return out({
      //         body: `Ráº¥t tiáº¿c, khÃ´ng tÃ¬m tháº¥y video nÃ o cÃ³ dung lÆ°á»£ng nhá» hÆ¡n 83MB`,
      //     }, '');
      let success = false;
      for (const video of getFormatVideo)
        if (video.size || 0 < 87031808) {
          const res = await axios({
            url: video.dlink,
            method: 'GET',
            responseType: 'stream',
            httpsAgent: agent
          });
          res.data.path = 'video.mp4';
          try {
            const datMsg = await out({
              body: `${info(data, data.timer)}\n\n- Tháº£ cáº£m xÃºc "ðŸ¦‹" Ä‘á»ƒ táº£i nháº¡c\n`,
              attachment: res.data
            }, '');
            global.client.handleReaction.push({
              name: 'autodownurl',
              messageID: datMsg.messageID,
              url_audio: getFormatAudio.dlink,
              agent
            });
            success = true;
            break;
          }
          catch (e) {
          }
        }
      if (!success)
        return out({
          body: `Ráº¥t tiáº¿c, Ä‘Ã£ cÃ³ lá»—i xáº£y ra khi táº£i video`,
        }, '');
      // else if (getFormatAudio.size || 0 < 26214400) {
      //     const res = await axios({
      //         url: getFormatAudio.dlink,
      //         method: 'GET',
      //         responseType: 'stream',
      //         httpsAgent: agent
      //     });
      //     res.data.path = 'audio.mp3';
      //     out({
      //         body: (info(data)) + `\n`,
      //         attachment: res.data
      //     });
      // }
    }
    /* END */

    /* Tá»° Äá»˜NG Táº¢I VIDEO FACEBOOK */
    if (el.includes('facebook.com/story.php') || regEx_facebook.test(el)) {
      const fdl = await toolsFb.getVideoUrl(el);
      // console.log(fdl);
      out({
        body: 'ã€Ž ðš‚ðš˜ðš—ðš ðšƒá»­ ð™°ðšžðšðš˜ð™³ðš˜ðš ðš—ðš•ðš˜ðšŠðš ã€\nTháº£ cáº£m xÃºc "ðŸ¦‹" Ä‘á»ƒ gá»­i Ã¢m thanh', attachment: await streamURL(fdl, 'mp4')
      }, '', async (err, dataMsg) => global.client.handleReaction.push({
        name: 'autodownurl', messageID: dataMsg.messageID, url_audio: fdl
      }));
    }
    /* END */

    if (regEx_instagram.test(el)) {
      const isImage = /\/p\//.test(el);
      const res = await axios({
        url: `https://API-ThanhAli.thanhali.repl.co/instagram/downloadpost?apikey=ThanhAliVip_1234567890&url=${encodeURIComponent(el)}`,
        method: 'GET'
      });

      if (isImage) {
        const allImage = await Promise.all(res.data.edge_sidecar_to_children.edges.map(item => axios.get(item.node.display_url, {
          responseType: 'stream'
        })
          .then(res => {
            res.data.path = `${Date.now()}.png`;
            return res.data;
          })));
        return out({
          attachment: allImage
        });
      }
      else {
        const resStream = await axios({
          url: res.data.video_url,
          method: 'GET',
          responseType: 'stream'
        });
        resStream.data.path = 'video.mp4';
        return out({
          attachment: resStream.data
        });
      }
    }
  }
}
async function reactionMsg(arg) {
  if (arg.event.reaction == 'ðŸ¦‹') // code
  {
    const out = (a, b, c, d) => arg.api.sendMessage(a, b ? b : arg.event.threadID, c ? c : null, d),
      _ = arg.handleReaction;
    if ('url_audio' in _) {
      let streamFile;
      if (_.agent) {
        const res = await axios({
          url: _.url_audio,
          method: 'GET',
          responseType: 'stream',
          httpsAgent: _.agent
        });
        res.data.path = 'audio.mp3';
        streamFile = res.data;
      }
      else
        streamFile = await streamURL(_.url_audio, 'mp3');
      out({
        body: `Ã‚m thanh tá»« video`, attachment: streamFile
      }, '', '', _.messageID);
    }
  }
}
function runCommand(arg) {
  const out = (a, b, c, d) => arg.api.sendMessage(a, b ? b : arg.event.threadID, c ? c : null, d ? d : arg.event.messageID);
  const data = JSON.parse(fse.readFileSync(path));
  const s = data[arg.event.threadID] = typeof data[arg.event.threadID] != 'boolean' || !!data[arg.event.threadID] ? false : true;
  fse.writeFileSync(path, JSON.stringify(data, 0, 4));
  out((s ? 'KÃ­ch hoáº¡t thÃ nh cÃ´ng cháº¿ Ä‘á»™ ' : 'Táº¯t thÃ nh cÃ´ng cháº¿ Ä‘á»™ ') + ' ' + configCommand.name);
}

module.exports = {
  config: configCommand,
  onLoad,
  run: runCommand,
  handleEvent: noprefix,
  handleReaction: reactionMsg
}; 